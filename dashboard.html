<!DOCTYPE html>
<html lang="en">
<head>
    <title>F.L.A.M.E.S. | Dashboard</title>
    <link rel="icon" type="image/png" href="icons/heading-logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <style>
        :root {
            --bg-deep: #0d0302;
            --bg-panel: #1a0905ee;
            --bg-card: #200b06dd;
            --border: #4a1a0a55;
            --border-glow: #8b3a1a44;
            --accent: #e14f00;
            --accent-soft: #c43d0088;
            --text: #f0d0b8;
            --text-dim: #9a6a5a;
            --text-muted: #5a3a2a;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --red: #ff4757;
            --orange-offline: #ff9f1c;
        }
        [data-theme="light"] {
            --bg-deep: #f5ede8;
            --bg-panel: #ffffffee;
            --bg-card: #fdf5f0ee;
            --border: #c8a08844;
            --border-glow: #d4896044;
            --text: #2a1208;
            --text-dim: #7a4a35;
            --text-muted: #b88a70;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden; /* desktop: grid fills viewport */
        }
        body {
            background: var(--bg-deep);
            font-family: Arial, sans-serif;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }
        /* On mobile, body must scroll since grid becomes flow layout */
        @media (max-width: 1100px) {
            html, body { height: auto; overflow: auto; overflow-x: hidden; }
        }
        /* ===== HEADER ===== */
        #main-header {
            height: 64px;
            background: linear-gradient(to right, #180401f5, #3a1005f5);
            border-bottom: 1px solid #5a1a0a55;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; position: relative; z-index: 1000;
            box-shadow: 0 4px 20px #00000066;
        }
        [data-theme="light"] #main-header { background: linear-gradient(to right, #f5e8e0f5, #f0d5c8f5); border-bottom: 1px solid #c8a08866; }
        .header-logo { display: flex; align-items: center; gap: 10px; }
        .header-logo img { width: 44px; filter: drop-shadow(0 0 8px #e14f0077); }
        .header-logo h1 {
            font-family: 'Cinzel', serif; font-size: 26px; letter-spacing: 1px; font-weight: 800;
            background: linear-gradient(to bottom, #ff7733, #9b1a00);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .username-badge {
            font-size: 13px; color: var(--text-dim); letter-spacing: 1px;
            background: #3a0a0444; border: 1px solid var(--border); border-radius: 20px;
            padding: 4px 14px;
        }
        [data-theme="light"] .username-badge { background: #f0d5c844; }
        .ws-indicator { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim); }
        .ws-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; transition: background 0.3s; }
        .ws-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse-dot 2s ease infinite; }
        .ws-dot.error { background: var(--red); }
        @keyframes pulse-dot { 0%,100%{opacity:1}50%{opacity:0.4} }
        .profile-icon-btn { background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; transition: 0.2s; }
        .profile-icon-btn img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent; transition: border-color 0.2s; }
        .profile-icon-btn:hover img { border-color: var(--accent); }
        /* ===== SIDE PANEL ===== */
        .side-panel {
            position: fixed; top: 0; right: -360px; width: 300px; height: 100%;
            background: linear-gradient(to bottom, #1a0805f5, #120404f5);
            border-left: 1px solid #5a1a0a55;
            box-shadow: -10px 0 40px #00000088;
            z-index: 20000; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; padding: 20px;
        }
        [data-theme="light"] .side-panel { background: linear-gradient(to bottom, #fdf5f0f5, #f5e8e0f5); border-left: 1px solid #c8a08855; }
        .side-panel.active { right: 0; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid #4a1a0a55; margin-bottom: 20px; }
        .panel-header h2 { font-family: Arial, sans-serif; font-size: 15px; color: var(--text); letter-spacing: 2px; }
        .close-btn { font-size: 22px; color: var(--text-dim); cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--accent); }
        .panel-section { background: #3a0a0433; border: 1px solid #4a1a0a44; border-radius: 10px; padding: 14px 16px; margin-bottom: 14px; }
        [data-theme="light"] .panel-section { background: #f0d5c833; border-color: #c8a08844; }
        .panel-section h3 { font-size: 11px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; }
        .setting-item span { font-size: 14px; color: var(--text); }
        .theme-switch { position: relative; display: inline-block; width: 52px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top:0;left:0;right:0;bottom:0; background: #2a1a14; border-radius: 26px; transition: 0.4s; display: flex; align-items: center; }
        .slider:before { position: absolute; content: "üåô"; font-size: 13px; height: 20px; width: 20px; left: 3px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: #c8a08855; }
        input:checked + .slider:before { content: "‚òÄÔ∏è"; transform: translateX(26px); }
        .logout-btn {
            margin-top: auto; background: transparent; border: 1px solid #4a1a0a55; color: var(--text-dim);
            padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-family: 'Cinzel', serif; font-size: 14px; width: 100%; transition: 0.3s;
        }
        .logout-btn:hover { background: #5a0a0533; border-color: var(--accent); color: var(--text); }
        .logout-btn img { width: 18px; opacity: 0.7; }
        .panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 15000; backdrop-filter: blur(4px); }
        .panel-overlay.active { display: block; }
        /* ===== LAYOUT GRID ===== */
        .dashboard-grid {
            position: absolute; top: 64px; left: 0; right: 0; bottom: 0;
            padding: 15px;
            display: grid;
            grid-template-columns: 60% 1fr;
            grid-template-rows: auto 1fr;
            gap: 10px;
            /* Prevent body scroll on desktop ‚Äî grid fills viewport */
            overflow: hidden;
        }
        .sensor-bar-cell { grid-column: 1; grid-row: 1; }
        .sensor-bar { margin-top: 0 !important; }
        .map-col { grid-column: 1; grid-row: 2; position: relative; }
        .search-cell { grid-column: 2; grid-row: 1; }
        .mid-right-cell {
            grid-column: 2; grid-row: 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            min-height: 0;
        }

        /* ===== RIGHT COLUMN WRAPPER (handles view switching) ===== */
        .right-col-wrapper {
            grid-column: 2;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        /* Default view: search + pinned + incidents stacked */
        .right-default-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        .right-default-view.hidden {
            display: none;
        }
        .right-mid-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            flex: 1;
            min-height: 0;
        }

        /* History panel ‚Äî takes full right column */
        .right-history-view {
            display: none;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            animation: hv-slidein 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .right-history-view.visible {
            display: flex;
        }
        @keyframes hv-slidein {
            from { opacity: 0; transform: translateX(20px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        /* ===== TABLET (max 1100px) ===== */
        @media (max-width: 1100px) {
            .dashboard-grid {
                position: relative; top: 0;
                display: flex; flex-direction: column;
                height: auto; padding: 10px; gap: 10px;
                overflow: visible;
            }
            .right-col-wrapper { grid-column: unset; grid-row: unset; min-height: 500px; }
            .right-mid-row { grid-template-columns: 1fr 1fr; }
            .flames-map-wrap { height: 55vw; min-height: 300px; }
            .sensor-tile { padding: 14px 12px; }
        }

        /* ===== MOBILE (max 768px) ===== */
        @media (max-width: 768px) {
            /* Header */
            #main-header {
                height: auto; min-height: 52px;
                padding: 8px 12px;
                flex-wrap: nowrap; gap: 8px;
            }
            .header-logo img { width: 30px; }
            .header-logo h1 { font-size: 13px; letter-spacing: 2px; }
            .username-badge { font-size: 11px; padding: 3px 10px; }
            .ws-indicator { font-size: 11px; }
            .ws-dot { width: 7px; height: 7px; }
            .profile-icon-btn img { width: 30px; height: 30px; }
            #admin-btn { font-size: 10px !important; padding: 4px 8px !important; letter-spacing: 1px !important; }

            /* Grid ‚Üí single column stack */
            .dashboard-grid {
                position: relative; top: 0;
                display: flex; flex-direction: column;
                height: auto; padding: 8px; gap: 8px;
            }

            /* Sensor bar ‚Üí 2x2 grid */
            .sensor-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
            .sensor-tile { padding: 12px 10px; min-width: unset; flex: unset; }
            .sensor-tile img { width: 18px; }
            .sensor-tile-label { font-size: 9px; }
            .sensor-tile-val { font-size: 15px; }
            .sensor-node-info {
                margin-left: auto; text-align: right; font-size: 10px;
                white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                max-width: 40%; padding-left: 4px;
            }

            /* Map */
            .map-col { width: 100%; }
            .flames-map-wrap { height: 65vw; min-height: 260px; }
            #flames-map { min-height: 260px; }

            /* Right column */
            .right-col-wrapper { width: 100%; min-height: unset; }
            .right-default-view { min-height: unset; }
            .right-mid-row { grid-template-columns: 1fr 1fr; gap: 8px; }
            .pinned-panel { min-height: 120px; }
            .incidents-panel { min-height: 200px; }

            /* Panels */
            .panel { padding: 12px; }
            .panel-title { font-size: 10px; margin-bottom: 8px; }
            .pinned-num { font-size: 28px; }
            .incident-title { font-size: 13px; }
            .incident-meta { font-size: 11px; }
            .btn-route { font-size: 12px; padding: 6px; }
            .incident-badge { font-size: 12px; }

            /* Route info box */
            #route-info-box {
                left: 8px; right: 8px; transform: none;
                width: auto; font-size: 12px;
                padding: 8px 10px; gap: 8px;
            }
            #route-dist img, #route-time img { width: 16px; }

            /* Side panel full width */
            .side-panel { width: 100%; right: -100%; }

            /* History panel on mobile: show as full-screen overlay */
            .right-history-view.visible {
                position: fixed;
                inset: 0;
                top: 0;
                z-index: 5000;
                background: var(--bg-deep);
                padding: 0;
                animation: hv-slidein 0.25s ease;
                overflow: hidden;
            }
            .right-history-view.visible .history-panel {
                border-radius: 0;
                border: none;
                height: 100dvh;
                height: 100vh;
                overflow: hidden;
            }

            /* History panel internals ‚Äî tighter on mobile */
            .hp-back-row { padding: 10px 14px 8px; gap: 8px; }
            .hp-back-btn { padding: 5px 10px; font-size: 11px; }
            .hp-node-badge { font-size: 9px; padding: 2px 10px; letter-spacing: 1px; }
            .hp-controls { padding: 8px 14px 6px; gap: 6px; }
            .hp-limit-btn { padding: 3px 10px; font-size: 10px; }
            .hp-stats { padding: 6px 14px 0; gap: 5px; }
            .hp-stat { padding: 4px 10px; font-size: 10px; }
            .hp-stat-label { font-size: 8px; }
            .hp-chart-wrap { padding: 6px 14px 0; }
            .hp-chart-tabs { gap: 3px; margin-bottom: 5px; }
            .hp-chart-tab { padding: 3px 8px; font-size: 9px; letter-spacing: 0.5px; }
            .hp-chart { height: 60px; }
            .hp-table-wrap { padding: 0 14px 14px; }
            .hp-table-header {
                grid-template-columns: 22px 86px 46px 40px 46px 40px 52px 42px 36px;
                padding: 6px 6px;
                margin-top: 8px;
            }
            .hp-table-header span { font-size: 8px; letter-spacing: 0.8px; }
            .hp-table { font-size: 11px; }
            .hp-table tbody td { padding: 6px 6px; }
            .hp-table td.hp-time { font-size: 9px; }
        }

        /* ===== SMALL MOBILE (max 480px) ===== */
        @media (max-width: 480px) {
            .header-logo h1 { font-size: 12px; letter-spacing: 1px; }
            .header-logo img { width: 26px; }
            .username-badge { display: none; }
            .ws-indicator span { display: none; }

            .sensor-bar { grid-template-columns: 1fr 1fr; gap: 5px; }
            .sensor-tile { padding: 10px 8px; }
            .sensor-tile-val { font-size: 13px; }

            .flames-map-wrap { height: 70vw; min-height: 220px; }
            #flames-map { min-height: 220px; }

            /* Stack pinned + incidents vertically on very small screens */
            .right-mid-row { grid-template-columns: 1fr; gap: 8px; }
            .pinned-panel { min-height: 100px; }
            .incidents-panel { min-height: 160px; }

            /* History table on tiny phones: horizontal scroll */
            .hp-table-wrap { overflow-x: auto; }
            .hp-table-header {
                min-width: 440px;
                grid-template-columns: 22px 82px 46px 40px 46px 40px 52px 42px 36px;
            }
            .hp-table-body-scroll { overflow-x: auto; }
            .hp-table { min-width: 440px; }

            /* Stat pills: 2 per row */
            .hp-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
            .hp-stat { padding: 5px 8px; }

            /* Chart tabs: 2 per row */
            .hp-chart-tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
            .hp-chart-tab { text-align: center; padding: 4px 6px; }

            /* Admin modal full-width */
            #admin-modal { padding: 10px 0; }
            #admin-modal > div { width: 96vw; border-radius: 12px; }
            #admin-tabs-row { flex-wrap: wrap; gap: 4px; padding: 10px 14px 0; }
            #admin-tabs-row button { font-size: 9px !important; padding: 7px 10px !important; letter-spacing: 1px !important; }
            #admin-modal > div > div:last-child { padding: 16px 14px 20px; }
        }

        /* ===== PANELS ===== */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-top: 1px solid var(--border-glow);
            border-radius: 12px;
            padding: 16px;
            overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 8px 30px #00000044, inset 0 1px 0 #8b3a1a22;
        }
        .panel-title { font-size: 11px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .panel-title img { width: 16px; opacity: 0.7; }

        /* SEARCH */
        .search-panel { flex-shrink: 0; overflow: visible !important; }
        .search-wrap { position: relative; }
        .search-wrap input {
            width: 100%; background: #12060566; border: 1px solid #4a1a0a;
            border-radius: 8px; padding: 10px 40px 10px 12px;
            color: var(--text); font-family: Arial, sans-serif; font-size: 14px; outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .search-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 12px #e14f0033; }
        .search-wrap input::placeholder { color: var(--text-muted); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 20px; opacity: 0.5; pointer-events: none; }
        .clr-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text); font-size: 18px; cursor: pointer; display: none; z-index: 5; }
        .suggestions-box {
            position: absolute; top: calc(100% + 4px); left: 0; right: 0;
            background: #1e0905f5; border: 1px solid var(--accent);
            border-radius: 8px; max-height: 180px; overflow-y: auto; display: none; z-index: 9999 !important;
        }
        .suggestion-item { padding: 9px 12px; font-size: 13px; color: var(--text); cursor: pointer; border-bottom: 1px solid #3a1a0a44; }
        .suggestion-item:hover { background: #3a1a0a55; }

        /* PINNED */
        .pinned-panel { flex: 1; min-height: 0; overflow: hidden; padding: 12px 16px; }
        .pinned-count-view { display: flex; justify-content: space-between; align-items: flex-end; }
        .pinned-num { font-size: 36px; font-family: Arial, sans-serif; color: var(--text); line-height: 1; }
        .pinned-label { font-size: 12px; color: var(--text-dim); margin-top: 3px; }
        .btn-small {
            background: transparent; border: 1px solid #4a1a0a; color: var(--text);
            padding: 6px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: Arial, sans-serif; transition: 0.3s;
        }
        .btn-small:hover { background: linear-gradient(to right, #8b1a00, #c43d00); border-color: var(--accent); }
        .pinned-list { display: none; flex-direction: column; gap: 6px; overflow-y: auto; flex: 1; padding-top: 8px; }
        .pinned-list.visible { display: flex; }
        .pinned-item {
            background: #2a0a0555; border: 1px solid #3a1a0a44; border-radius: 8px; padding: 8px 10px;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px;
        }
        .pinned-item-name { color: var(--text); font-weight: 500; }
        .pinned-item-coords { color: var(--text-dim); font-size: 11px; }
        .pinned-item-actions { display: flex; gap: 6px; }
        .btn-icon-sm { background: none; border: none; cursor: pointer; padding: 3px 6px; border-radius: 4px; font-size: 12px; color: var(--text-dim); transition: 0.2s; }
        .btn-icon-sm:hover { background: #5a1a0a44; color: var(--text); }
        .no-pinned { color: var(--text-muted); font-size: 13px; text-align: center; margin-top: 12px; }

        /* MAP */
        .flames-map-wrap {
            border-radius: 12px; overflow: hidden; height: 100%;
            border: 1px solid #09000099;
            box-shadow: 0 8px 30px #00000066;
            position: relative;
        }
        #flames-map { width: 100%; height: 100%; min-height: 400px; }
        .map-btn {
            position: absolute; z-index: 1000;
            background: white; border: 2px solid var(--accent);
            border-radius: 50%; width: 34px; height: 34px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px #00000055; transition: 0.2s;
        }
        .map-btn:hover { background: #1a0500cc; outline: 3px solid var(--accent); }
        .map-btn img { width: 20px; height: 20px; }
        #home-btn { top: 12px; right: 12px; }
        #locate-btn { top: 54px; right: 12px; }
        #route-btn { top: 96px; right: 12px; border-radius: 50%; width: 34px; height: 34px; }
        #route-btn img { width: 24px; height: 24px; }
        .zoom-group {
            position: absolute; bottom: 20px; right: 12px; z-index: 1000;
            display: flex; flex-direction: column;
            background: white; border: 2px solid var(--accent); border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 8px #00000055;
        }
        .zoom-group:hover { outline: 3px solid var(--accent); }
        .zoom-btn { background: transparent; border: none; color: var(--accent); font-size: 14px; font-weight: bold; padding: 8px 0; width: 34px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .zoom-btn:hover { background: #e14f0022; }
        .zoom-div { height: 1px; background: #e14f0044; }

        /* ROUTE MENU */
        .route-menu {
            position: absolute; top: 138px; right: 12px; z-index: 1001;
            background: #2a0a06ee; border: 2px solid var(--accent); border-radius: 10px;
            padding: 4px 10px; display: none; align-items: center; gap: 4px;
            box-shadow: 0 4px 15px #00000055;
        }
        .route-menu.visible { display: flex; }
        .route-menu button { background: none; border: none; color: white; padding: 8px 12px; cursor: pointer; font-family: Arial, sans-serif; font-size: 14px; border-radius: 6px; transition: background 0.2s; }
        #calc-route:hover { background: #e14f0055; }
        #clear-route:hover { background: #ff000055; }
        .route-divider { color: #e14f0066; }

        /* ROUTE INFO BOX */
        #route-info-box {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            z-index: 1001; background: #1a0806ee; border: 2px solid var(--accent);
            border-radius: 10px; padding: 10px 16px; display: none; align-items: center; gap: 14px;
            box-shadow: 0 4px 15px #00000055; white-space: nowrap;
            font-family: Arial, sans-serif;
        }
        #route-dist { color: var(--green); font-weight: 700; display: flex; align-items: center; gap: 5px; }
        #route-time { color: var(--yellow); font-weight: 700; display: flex; align-items: center; gap: 5px; }
        #route-dist img, #route-time img { width: 22px; }
        .info-div { color: #5a3a2a; }
        #close-info-btn { background: none; border: none; color: white; cursor: pointer; font-size: 20px; margin-left: 6px; transition: color 0.2s; }
        #close-info-btn:hover { color: var(--red); }

        /* RIGHT COLUMN panels */
        .pinned-panel { min-height: 0; overflow: hidden; display: flex; flex-direction: column; }
        .incidents-panel { min-height: 0; display: flex; flex-direction: column; }
        .node-placeholder { color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px 0; }
        .badge-status { font-size: 11px; letter-spacing: 1px; padding: 3px 8px; border-radius: 10px; font-weight: 600; }
        .badge-online { background: #2ecc7133; color: var(--green); border: 1px solid #2ecc7155; }
        .badge-offline { background: #ff475733; color: var(--red); border: 1px solid #ff475755; }
        .badge-alert { background: #ff450033; color: #ff7733; border: 1px solid #ff450055; animation: blink 1s ease infinite; }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.5} }
        .incident-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .incident-badge { background: #5a0a00; border: 1px solid #8b2a0055; border-radius: 8px; padding: 4px 10px; display: flex; align-items: center; gap: 5px; font-weight: 700; font-size: 14px; }
        .incident-badge img { width: 14px; }
        .incident-list { overflow-y: auto; flex: 1; padding-right: 4px; }
        .incident-list::-webkit-scrollbar { width: 4px; }
        .incident-list::-webkit-scrollbar-thumb { background: #4a2b27; border-radius: 10px; }
        .incident-card { border-bottom: 1px solid #3a1a0a44; padding: 8px 0; }
        .incident-title { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .incident-meta { font-size: 12px; color: var(--text-dim); margin-bottom: 3px; }
        .txt-active { color: var(--red); font-weight: 700; }
        .txt-contained { color: var(--yellow); font-weight: 700; }
        .txt-resolved { color: var(--green); font-weight: 700; }
        .btn-route {
            width: 100%; margin-top: 8px; padding: 7px;
            background: #c43d0066; border: 1px solid var(--accent);
            color: white; border-radius: 7px; font-family: Arial, sans-serif; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: 0.3s; letter-spacing: 1px;
        }
        .btn-route:hover { background: var(--accent); box-shadow: 0 0 15px #e14f0055; }

        /* LIVE TAG */
        .live-tag { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--green); letter-spacing: 1px; }
        .live-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse-dot 1.5s ease infinite; }

        /* SCROLLBAR global */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4a2020; border-radius: 10px; }

        /* SENSOR BAR */
        .sensor-bar {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .sensor-tile {
            flex: 1; min-width: 120px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-top: 1px solid var(--border-glow);
            border-radius: 12px;
            padding: 30px 16px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 16px #00000033;
        }
        .sensor-tile img { width: 22px; opacity: 0.85; flex-shrink: 0; }
        .sensor-tile-label { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
        .sensor-tile-val { font-size: 18px; font-weight: 700; color: #ff904f; font-family: Arial, sans-serif; }
        .sensor-tile-val.alert { color: var(--red); }
        .sensor-tile-val.ok { color: var(--green); }
        .sensor-node-info { margin-left: auto; text-align: right; font-size: 11px; color: var(--text-muted); }

        .leaflet-popup-content-wrapper { background: #1e0a08f5 !important; color: white !important; border-radius: 12px !important; border: 2px solid var(--accent) !important; }
        .leaflet-popup-tip { background: #1e0a08 !important; }
        .popup-title { font-family: Arial, sans-serif; font-size: 13px; margin-bottom: 8px; color: #ff9055; }
        .popup-coords { font-size: 12px; color: #7a4a3a; margin-bottom: 12px; }
        .popup-input { width: 100%; background: #2a0a0566; border: 1px solid #4a1a0a; border-radius: 6px; padding: 7px 9px; color: white; font-family: Arial, sans-serif; font-size: 13px; outline: none; margin-bottom: 8px; }
        .popup-input:focus { border-color: var(--accent); }
        .popup-actions { display: flex; gap: 8px; }
        .popup-save { flex: 1; background: #8b2200; border: none; color: white; padding: 7px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: Arial, sans-serif; transition: 0.2s; }
        .popup-save:hover { background: var(--accent); }
        .popup-cancel { background: transparent; border: 1px solid #4a1a0a44; color: #7a4a3a; padding: 7px 12px; border-radius: 6px; cursor: pointer; font-family: Arial, sans-serif; }

        /* ‚îÄ‚îÄ "View History" button in node popup ‚îÄ‚îÄ */
        .popup-history-btn {
            width: 100%; margin-top: 10px; padding: 7px;
            background: #2a1a0066; border: 1px solid #c43d0088;
            color: #ff9055; border-radius: 7px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            letter-spacing: 1px; transition: 0.25s;
            font-family: Arial, sans-serif;
        }
        .popup-history-btn:hover {
            background: linear-gradient(135deg,#6b1200,#a03000);
            color: white; border-color: var(--accent);
            box-shadow: 0 0 12px #e14f0044;
        }

        /* ‚îÄ‚îÄ INLINE HISTORY PANEL ‚îÄ‚îÄ */
        .history-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-top: 1px solid var(--border-glow);
            border-radius: 12px;
            padding: 0;
            display: flex; flex-direction: column;
            box-shadow: 0 8px 30px #00000044, inset 0 1px 0 #8b3a1a22;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Back button row */
        .hp-back-row {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px 10px;
            border-bottom: 1px solid #3a1a0a44;
            flex-shrink: 0;
        }
        .hp-back-btn {
            display: flex; align-items: center; gap: 6px;
            background: transparent; border: 1px solid #4a1a0a55;
            color: var(--text-dim); border-radius: 8px; padding: 5px 12px;
            font-size: 12px; cursor: pointer; transition: 0.2s; font-family: Arial, sans-serif;
        }
        .hp-back-btn:hover { border-color: var(--accent); color: var(--text); background: #3a0a0433; }
        .hp-back-arrow { font-size: 14px; }
        .hp-node-badge {
            font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px;
            color: #ff7033; background: #3a0a0455;
            border: 1px solid #c43d0055; border-radius: 20px; padding: 3px 12px;
            margin-left: auto;
        }

        /* Controls row */
        .hp-controls {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 16px 8px; border-bottom: 1px solid #2a1a0a33;
            flex-shrink: 0; flex-wrap: wrap;
        }
        .hp-limit-label { font-size: 10px; color: #7a4a3a; letter-spacing: 1px; text-transform: uppercase; }
        .hp-limit-btn {
            background: #2a0a0455; border: 1px solid #4a1a0a55;
            color: #9a6a5a; padding: 4px 12px; border-radius: 6px;
            font-size: 11px; cursor: pointer; transition: 0.2s;
        }
        .hp-limit-btn.active, .hp-limit-btn:hover {
            background: linear-gradient(135deg,#6b1200,#a03000);
            border-color: var(--accent); color: white;
        }
        .hp-refresh {
            margin-left: auto; background: none;
            border: 1px solid #4a1a0a55; border-radius: 6px;
            color: #9a6a5a; padding: 4px 12px; font-size: 11px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .hp-refresh:hover { border-color: #2ecc71; color: #2ecc71; }
        .hp-refresh-icon { display: inline-block; transition: transform 0.5s; }
        .hp-refresh.spinning .hp-refresh-icon { transform: rotate(360deg); }

        /* Stat pills */
        .hp-stats {
            display: flex; gap: 6px; padding: 8px 16px 0; flex-wrap: wrap; flex-shrink: 0;
        }
        .hp-stat {
            background: #2a0a0444; border: 1px solid #3a1a0a55; border-radius: 8px;
            padding: 5px 12px; font-size: 11px;
            display: flex; align-items: center; gap: 5px;
        }
        .hp-stat-label { color: #5a3a2a; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }
        .hp-stat-val { color: #ff904f; font-weight: 700; }

        /* Sparkline + metric tabs */
        .hp-chart-wrap { padding: 8px 16px 0; flex-shrink: 0; }
        .hp-chart-tabs {
            display: flex; gap: 4px; margin-bottom: 6px; flex-wrap: wrap;
        }
        .hp-chart-tab {
            padding: 3px 10px; border-radius: 5px; font-size: 10px; font-weight: 700;
            letter-spacing: 1px; cursor: pointer; border: 1px solid transparent;
            transition: 0.2s; background: #2a0a0444; color: #5a3a2a;
        }
        .hp-chart-tab:hover { opacity: 0.85; }
        .hp-chart-tab.active { color: white; }
        .hp-chart-tab[data-metric="temperature"]         { border-color: #ff6b3555; }
        .hp-chart-tab[data-metric="temperature"].active  { background: #ff6b3533; border-color: #ff6b35; color: #ff8555; }
        .hp-chart-tab[data-metric="humidity"]            { border-color: #3d9cff55; }
        .hp-chart-tab[data-metric="humidity"].active     { background: #3d9cff22; border-color: #3d9cff; color: #6db8ff; }
        .hp-chart-tab[data-metric="smoke"]               { border-color: #b0b0b055; }
        .hp-chart-tab[data-metric="smoke"].active        { background: #b0b0b022; border-color: #c8c8c8; color: #d8d8d8; }
        .hp-chart-tab[data-metric="flame"]               { border-color: #ff475755; }
        .hp-chart-tab[data-metric="flame"].active        { background: #ff475722; border-color: #ff4757; color: #ff6575; }
        .hp-chart-label {
            font-size: 9px; color: #5a3a2a; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 5px;
        }
        .hp-chart {
            height: 70px; background: #12050344; border-radius: 8px;
            border: 1px solid #3a1a0a44; padding: 6px 8px;
            position: relative; overflow: hidden;
        }
        .hp-chart svg { width: 100%; height: 100%; overflow: visible; }

        /* Table */
        .hp-table-wrap {
            flex: 1; overflow-y: auto; padding: 0 16px 16px;
            display: flex; flex-direction: column; min-height: 0;
        }
        .hp-table-wrap::-webkit-scrollbar { width: 4px; }
        .hp-table-wrap::-webkit-scrollbar-thumb { background: #4a2020; border-radius: 10px; }
        .hp-table-header {
            display: grid;
            grid-template-columns: 28px 108px 60px 50px 55px 50px 62px 54px 44px;
            gap: 0;
            background: #120503;
            border: 1px solid #3a1a0a55;
            border-radius: 8px 8px 0 0;
            padding: 7px 8px;
            flex-shrink: 0;
            margin-top: 10px;
        }
        .hp-table-header span {
            font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase;
            color: #7a4a3a; font-weight: 700;
        }
        .hp-table-body-scroll {
            flex: 1; overflow-y: auto; min-height: 0;
            border: 1px solid #3a1a0a44; border-top: none;
            border-radius: 0 0 8px 8px;
        }
        .hp-table-body-scroll::-webkit-scrollbar { width: 4px; }
        .hp-table-body-scroll::-webkit-scrollbar-thumb { background: #4a2020; border-radius: 10px; }
        .hp-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
        }
        .hp-table thead { display: none; }
        .hp-table tbody tr { border-bottom: 1px solid #2a1a0a33; transition: background 0.15s; }
        .hp-table tbody tr:hover { background: #3a1a0a22; }
        .hp-table tbody td { padding: 7px 8px; color: #c8a080; }
        .hp-table td.hp-num { color: #ff904f; font-weight: 600; font-family: monospace; }
        .hp-table td.hp-time { color: #5a3a2a; font-size: 10px; }

        /* Empty / loading */
        .hp-state { text-align: center; padding: 30px 15px; color: #4a2a1a; font-size: 13px; }
        .hp-spinner {
            width: 24px; height: 24px; border: 3px solid #3a1a0a;
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.7s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI badges inline */
        .ai-badge { display: inline-block; font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 6px; letter-spacing: 0.5px; }
        .ai-fire    { background: #ff475722; color: #ff4757; border: 1px solid #ff475544; }
        .ai-normal  { background: #2ecc7122; color: #2ecc71; border: 1px solid #2ecc7144; }
        .ai-unknown { background: #f1c40f22; color: #f1c40f; border: 1px solid #f1c40f44; }
    </style>
</head>
<body>

<!-- HEADER -->
<div id="main-header">
    <div class="header-logo">
        <img src="icons/logo.png" alt="FLAMES">
        <h1>F.L.A.M.E.S.</h1>
    </div>
    <div class="header-right">
        <div class="ws-indicator">
            <div class="ws-dot" id="ws-dot"></div>
            <span id="ws-label">Connecting‚Ä¶</span>
        </div>
        <div class="username-badge" id="username-badge">‚Äî</div>
        <button id="admin-btn" onclick="openAdminModal()" style="display:none;background:linear-gradient(135deg,#8b1a00,#c43d00);border:1px solid #e14f0055;color:white;padding:5px 14px;border-radius:8px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.3s;" onmouseover="this.style.boxShadow='0 0 15px #e14f0055'" onmouseout="this.style.boxShadow='none'">‚öô <span id="admin-btn-label">PANEL</span></button>
        <button class="profile-icon-btn" id="profile-btn">
            <img src="icons/Profile.png" alt="Profile">
        </button>
    </div>
</div>

<!-- SIDE PANEL -->
<div id="side-panel" class="side-panel">
    <div class="panel-header">
        <h2>SETTINGS</h2>
        <span class="close-btn" id="close-panel">‚úï</span>
    </div>
    <div class="panel-section">
        <h3>Display</h3>
        <div class="setting-item">
            <span>Theme: <strong id="mode-text">Dark</strong></span>
            <label class="theme-switch">
                <input type="checkbox" id="mode-toggle" checked>
                <div class="slider"></div>
            </label>
        </div>
    </div>
    <button class="logout-btn" id="logout-trigger">
        <img src="icons/logout-icon.png" alt="logout">
        <span style="font-family: Arial, sans-serif;">Log Out</span>
    </button>
</div>
<div id="panel-overlay" class="panel-overlay"></div>

<!-- DASHBOARD GRID -->
<div class="dashboard-grid">
    <!-- Sensor Bar -->
    <div class="sensor-bar-cell">
        <div class="sensor-bar" id="sensor-bar">
            <div class="sensor-tile">
                <img src="icons/temperature.png" alt="">
                <div>
                    <div class="sensor-tile-label">Temp.</div>
                    <div class="sensor-tile-val" id="sb-temp">‚Äî</div>
                </div>
                <div class="sensor-node-info" id="sb-node-label">No node</div>
            </div>
            <div class="sensor-tile">
                <img src="icons/humidity.png" alt="">
                <div>
                    <div class="sensor-tile-label">Hum.</div>
                    <div class="sensor-tile-val" id="sb-hum">‚Äî</div>
                </div>
            </div>
            <div class="sensor-tile">
                <img src="icons/smoke.png" alt="">
                <div>
                    <div class="sensor-tile-label">Smoke</div>
                    <div class="sensor-tile-val" id="sb-smoke">‚Äî</div>
                </div>
            </div>
            <div class="sensor-tile">
                <img src="icons/flame.png" alt="">
                <div>
                    <div class="sensor-tile-label">Flame</div>
                    <div class="sensor-tile-val" id="sb-flame">‚Äî</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="map-col">
        <div class="flames-map-wrap">
            <div id="flames-map"></div>
            <button class="map-btn" id="home-btn" title="Home"><img src="icons/home.png" alt="Home"></button>
            <button class="map-btn" id="locate-btn" title="My Location"><img src="icons/showmylocation.png" alt="Locate"></button>
            <button class="map-btn" id="route-btn" title="Route Planner" style="border-radius:50%;"><img src="icons/RoutePlanner.png" alt="Route"></button>
            <div class="route-menu" id="route-menu">
                <button id="calc-route">Calculate</button>
                <span class="route-divider">|</span>
                <button id="clear-route">Clear</button>
            </div>
            <div id="route-info-box">
                <span id="route-dist"><img src="icons/distance.png"> 0.00 km</span>
                <span class="info-div">|</span>
                <span id="route-time"><img src="icons/minutes.png"> 0 min</span>
                <button id="close-info-btn">√ó</button>
            </div>
            <div class="zoom-group">
                <button class="zoom-btn" id="zoom-in">+</button>
                <div class="zoom-div"></div>
                <button class="zoom-btn" id="zoom-out">‚àí</button>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN ‚Äî single wrapper that switches between default and history views -->
    <div class="right-col-wrapper">

        <!-- DEFAULT VIEW: Search + Pinned + Incidents -->
        <div class="right-default-view" id="right-default-view">
            <!-- Search -->
            <div class="panel search-panel">
                <div class="panel-title">
                    <span>Search Location</span>
                    <img src="icons/search-icon.png" alt="">
                </div>
                <div class="search-wrap">
                    <input type="text" id="mapSearchInput" placeholder="Search a place‚Ä¶" oninput="handleSearch(this.value)">
                    <span id="clearSearch" class="clr-btn" onclick="clearSearchInput()">√ó</span>
                    <img src="icons/search-icon.png" class="search-icon" id="search-icon-img" alt="">
                    <div id="suggestionsBox" class="suggestions-box"></div>
                </div>
            </div>

            <!-- Pinned + Incidents -->
            <div class="right-mid-row">
                <!-- Pinned Locations -->
                <div class="panel pinned-panel">
                    <div class="panel-title">
                        <span>Pinned</span>
                        <img src="icons/pinned-location.png" alt="">
                    </div>
                    <div class="pinned-count-view" id="pinned-count-view">
                        <div>
                            <div class="pinned-num" id="pinned-count">0</div>
                            <div class="pinned-label">locations saved</div>
                        </div>
                        <button class="btn-small" id="view-all-btn" onclick="togglePinnedList()">View All</button>
                    </div>
                    <div class="pinned-list" id="pinned-list">
                        <button class="btn-small" style="margin-bottom:8px;" onclick="togglePinnedList()">Hide</button>
                        <div class="no-pinned" id="no-pinned-msg">No locations pinned yet.</div>
                    </div>
                </div>

                <!-- Live Incidents -->
                <div class="panel incidents-panel">
                    <div class="incident-header-row">
                        <div class="panel-title" style="margin-bottom:0;">
                            <span>Live Incidents</span>
                            <span id="incidents-last-update" style="font-size:11px; color:greenyellow; margin-left:12px; opacity:0.8;"></span>
                        </div>
                        <div class="incident-badge">
                            <img src="icons/FireIncident.png" alt="fire">
                            <span id="incident-count">0</span>
                        </div>
                    </div>
                    <div class="incident-list" id="incident-list"></div>
                </div>
            </div>
        </div><!-- /right-default-view -->

        <!-- HISTORY VIEW: full-height history panel -->
        <div class="right-history-view" id="right-history-view">
            <div class="history-panel">
                <!-- Back button row -->
                <div class="hp-back-row">
                    <button class="hp-back-btn" onclick="closeHistoryPanel()">
                        <span class="hp-back-arrow">‚Üê</span> Back
                    </button>
                    <span style="font-size:12px; color:var(--text-dim); letter-spacing:1px;">SENSOR HISTORY</span>
                    <span class="hp-node-badge" id="hp-node-id">‚Äî</span>
                </div>

                <!-- Controls -->
                <div class="hp-controls">
                    <span class="hp-limit-label">Show:</span>
                    <button class="hp-limit-btn" onclick="setHistoryLimit(20)">20</button>
                    <button class="hp-limit-btn active" onclick="setHistoryLimit(50)">50</button>
                    <button class="hp-limit-btn" onclick="setHistoryLimit(100)">100</button>
                    <button class="hp-limit-btn" onclick="setHistoryLimit(200)">200</button>
                    <button class="hp-refresh" onclick="refreshHistory()" id="hp-refresh-btn">
                        <span class="hp-refresh-icon">‚ü≥</span> Refresh
                    </button>
                </div>

                <!-- Stats -->
                <div class="hp-stats" id="hp-stats"></div>

                <!-- Chart with metric tabs -->
                <div class="hp-chart-wrap">
                    <div class="hp-chart-tabs">
                        <button class="hp-chart-tab active" data-metric="temperature" onclick="switchChartMetric('temperature')">üå° Temp</button>
                        <button class="hp-chart-tab" data-metric="humidity" onclick="switchChartMetric('humidity')">üíß Humidity</button>
                        <button class="hp-chart-tab" data-metric="smoke" onclick="switchChartMetric('smoke')">üí® Smoke</button>
                        <button class="hp-chart-tab" data-metric="flame" onclick="switchChartMetric('flame')">üî• Flame</button>
                    </div>
                    <div class="hp-chart-label" id="hp-chart-label">Temperature Trend (¬∞C)</div>
                    <div class="hp-chart">
                        <svg id="hp-chart-svg" viewBox="0 0 800 70" preserveAspectRatio="none">
                            <text x="400" y="40" text-anchor="middle" fill="#3a1a0a" font-size="13">No data yet</text>
                        </svg>
                    </div>
                </div>

                <!-- Record count -->
                <div style="padding:4px 16px 0; font-size:11px; color:var(--text-muted); flex-shrink:0;">
                    <span id="hp-record-count">0 readings</span>
                </div>

                <!-- Table with fixed detached header -->
                <div class="hp-table-wrap">
                    <div class="hp-table-header" id="hp-table-header">
                        <span>#</span>
                        <span>Timestamp</span>
                        <span>Temp¬∞C</span>
                        <span>Hum%</span>
                        <span>Smoke</span>
                        <span>Flame</span>
                        <span>AI</span>
                        <span>Conf.</span>
                        <span>RSSI</span>
                    </div>
                    <div class="hp-table-body-scroll" id="hp-table-body">
                        <div class="hp-state">
                            <div class="hp-spinner"></div>
                            Select a node to view its history
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /right-history-view -->

    </div><!-- /right-col-wrapper -->
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- ADMIN MODAL -->
<div id="admin-modal" style="display:none;position:fixed;inset:0;z-index:30000;background:rgba(0,0,0,0.82);backdrop-filter:blur(6px);align-items:flex-start;justify-content:center;overflow-y:auto;padding:30px 0;">
    <div style="background:linear-gradient(135deg,#1e0a08,#2d1209);border:1px solid #5a1a0a88;border-radius:16px;width:680px;max-width:95vw;box-shadow:0 0 60px #3a0a0088;margin:auto;position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:22px 28px 18px;border-bottom:1px solid #4a1a0a55;">
            <h2 style="font-family:'Cinzel',serif;font-size:16px;color:#e8c4a0;letter-spacing:3px;">‚öô ADMIN PANEL</h2>
            <span onclick="closeAdminModal()" style="font-size:22px;color:#9a6a5a;cursor:pointer;line-height:1;transition:color 0.2s;" onmouseover="this.style.color='#e14f00'" onmouseout="this.style.color='#9a6a5a'">‚úï</span>
        </div>
        <div style="display:flex;gap:4px;padding:16px 28px 0;border-bottom:1px solid #4a1a0a44;" id="admin-tabs-row">
            <button id="admin-tab-invite" onclick="switchAdminTab('invite')" style="padding:9px 22px;border:none;border-radius:8px 8px 0 0;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.2s;background:linear-gradient(135deg,#8b1a00,#c43d00);color:white;">üéü INVITE CODES</button>
            <button id="admin-tab-users" onclick="switchAdminTab('users')" style="padding:9px 22px;border:none;border-radius:8px 8px 0 0;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.2s;background:#2a0a0466;color:#9a6a5a;">üë• USERS</button>
            <button id="admin-tab-orgs" onclick="switchAdminTab('orgs')" style="padding:9px 22px;border:none;border-radius:8px 8px 0 0;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.2s;background:#2a0a0466;color:#9a6a5a;">üè¢ ORGANIZATIONS</button>
        </div>
        <div style="padding:24px 28px 28px;">
            <!-- INVITE CODES TAB -->
            <div id="admin-panel-invite">
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;margin-bottom:18px;">
                    <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:3px;height:16px;background:#e14f00;border-radius:2px;flex-shrink:0;"></span>Generate Invite Code
                    </div>
                    <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:14px;margin-bottom:14px;">
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Organization</label>
                            <select id="admin-invite-org-select" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;">
                                <option value="">Select Organization</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Expires (days)</label>
                            <input id="admin-invite-expires" type="number" value="30" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;">
                        </div>
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Max Uses</label>
                            <input id="admin-invite-max-uses" type="number" value="1" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;">
                        </div>
                        <div style="display:flex;align-items:flex-end;">
                            <button onclick="adminGenerateInvite()" style="width:100%;padding:11px;background:linear-gradient(135deg,#8b1a00,#c43d00);border:1px solid #e14f0055;border-radius:8px;color:white;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.3s;" onmouseover="this.style.boxShadow='0 0 15px #e14f0055'" onmouseout="this.style.boxShadow='none'">Generate</button>
                        </div>
                    </div>
                    <div id="admin-invite-result" style="display:none;background:#0a160a;border:1px solid #2ecc7144;border-radius:10px;padding:18px;text-align:center;">
                        <div style="font-size:10px;color:#2ecc71;letter-spacing:3px;text-transform:uppercase;margin-bottom:10px;">‚úì Code Generated</div>
                        <div id="admin-invite-code-display" style="font-size:30px;font-weight:700;color:#f0d0b8;letter-spacing:8px;margin-bottom:8px;font-family:monospace;"></div>
                        <div id="admin-invite-meta" style="font-size:12px;color:#9a6a5a;margin-bottom:14px;"></div>
                        <button id="admin-copy-code-btn" onclick="adminCopyCode()" style="background:#2a0a0466;border:1px solid #4a1a0a;color:#f0d0b8;padding:7px 18px;border-radius:6px;cursor:pointer;font-size:13px;transition:0.2s;" onmouseover="this.style.borderColor='#e14f00'" onmouseout="this.style.borderColor='#4a1a0a'">üìã Copy Code</button>
                    </div>
                </div>
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;">
                    <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:3px;height:16px;background:#ff4757;border-radius:2px;flex-shrink:0;"></span>Delete Invite Code
                    </div>
                    <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-end;">
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Invite Code</label>
                            <input id="admin-delete-invite-input" type="text" placeholder="e.g. K7N4P8X2" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;text-transform:uppercase;" onfocus="this.style.borderColor='#ff4757';this.style.boxShadow='0 0 10px #ff475733'" onblur="this.style.borderColor='#4a1a0a';this.style.boxShadow='none'">
                        </div>
                        <button onclick="adminDeleteInvite()" style="padding:10px 18px;background:#1a000066;border:1px solid #ff475755;border-radius:8px;color:#ff4757;font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;cursor:pointer;white-space:nowrap;transition:0.3s;" onmouseover="this.style.background='#ff475722'" onmouseout="this.style.background='#1a000066'">Delete</button>
                    </div>
                </div>
            </div>
            <!-- USERS TAB -->
            <div id="admin-panel-users" style="display:none;">
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;margin-bottom:18px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;display:flex;align-items:center;gap:8px;">
                            <span style="display:inline-block;width:3px;height:16px;background:#e14f00;border-radius:2px;flex-shrink:0;"></span>All Users
                        </div>
                        <button onclick="adminLoadUsers()" style="padding:6px 16px;background:linear-gradient(135deg,#8b1a00,#c43d00);border:1px solid #e14f0055;border-radius:6px;color:white;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;cursor:pointer;transition:0.3s;">‚ü≥ Load</button>
                    </div>
                    <div id="admin-users-table" style="max-height:280px;overflow-y:auto;">
                        <div style="color:#5a3a2a;font-size:13px;text-align:center;padding:24px;">Click "Load" to fetch users.</div>
                    </div>
                </div>
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;">
                    <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:3px;height:16px;background:#ff4757;border-radius:2px;flex-shrink:0;"></span>Delete User by ID
                    </div>
                    <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-end;">
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">User ID</label>
                            <input id="admin-delete-user-input" type="number" placeholder="e.g. 5" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;" onfocus="this.style.borderColor='#ff4757';this.style.boxShadow='0 0 10px #ff475733'" onblur="this.style.borderColor='#4a1a0a';this.style.boxShadow='none'">
                        </div>
                        <button onclick="adminDeleteUser()" style="padding:10px 18px;background:#1a000066;border:1px solid #ff475755;border-radius:8px;color:#ff4757;font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;cursor:pointer;white-space:nowrap;transition:0.3s;" onmouseover="this.style.background='#ff475722'" onmouseout="this.style.background='#1a000066'">Delete</button>
                    </div>
                </div>
            </div>
            <!-- ORGS TAB -->
            <div id="admin-panel-orgs" style="display:none;">
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;margin-bottom:18px;">
                    <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:3px;height:16px;background:#e14f00;border-radius:2px;flex-shrink:0;"></span>Create New Organization
                    </div>
                    <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:14px;margin-bottom:14px;">
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Organization Name</label>
                            <input id="admin-create-org-name" type="text" placeholder="e.g. Dagupan Fire Dept" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;">
                        </div>
                        <div>
                            <label style="display:block;font-size:10px;color:#9a6a5a;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Expires (days)</label>
                            <input id="admin-create-org-expires" type="number" value="30" style="width:100%;background:#12060566;border:1px solid #4a1a0a;border-radius:8px;padding:10px 12px;color:#f0d0b8;font-size:14px;outline:none;">
                        </div>
                        <div style="display:flex;align-items:flex-end;">
                            <button onclick="adminCreateOrganization()" style="width:100%;padding:11px;background:linear-gradient(135deg,#8b1a00,#c43d00);border:1px solid #e14f0055;border-radius:8px;color:white;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;transition:0.3s;">Create Org</button>
                        </div>
                    </div>
                    <div id="admin-create-org-result" style="display:none;background:#0a160a;border:1px solid #2ecc7144;border-radius:10px;padding:18px;text-align:center;">
                        <div style="font-size:10px;color:#2ecc71;letter-spacing:3px;text-transform:uppercase;margin-bottom:10px;">‚úì Organization Created</div>
                        <div id="admin-create-org-name-display" style="font-size:20px;font-weight:700;color:#f0d0b8;margin-bottom:8px;"></div>
                        <div id="admin-create-org-meta" style="font-size:12px;color:#9a6a5a;"></div>
                    </div>
                </div>
                <div style="background:#2a0a0444;border:1px solid #4a1a0a55;border-radius:12px;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <div style="font-size:11px;letter-spacing:2px;color:#9a6a5a;text-transform:uppercase;display:flex;align-items:center;gap:8px;">
                            <span style="display:inline-block;width:3px;height:16px;background:#e14f00;border-radius:2px;flex-shrink:0;"></span>All Organizations
                        </div>
                        <button onclick="loadOrganizations()" style="padding:6px 16px;background:linear-gradient(135deg,#8b1a00,#c43d00);border:1px solid #e14f0055;border-radius:6px;color:white;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;cursor:pointer;transition:0.3s;">‚ü≥ Load</button>
                    </div>
                    <div id="admin-orgs-table" style="max-height:280px;overflow-y:auto;">
                        <div style="color:#5a3a2a;font-size:13px;text-align:center;padding:24px;">Click "Load" to fetch organizations.</div>
                    </div>
                </div>
            </div>
            <!-- Access Denied -->
            <div id="admin-panel-denied" style="display:none;text-align:center;padding:40px 20px;">
                <div style="font-size:48px;margin-bottom:14px;">üîí</div>
                <div style="color:#e8c4a0;font-family:'Cinzel',serif;font-size:14px;letter-spacing:3px;margin-bottom:10px;">ACCESS RESTRICTED</div>
                <div style="color:#9a6a5a;font-size:13px;">Only <strong style="color:#ff7733;">Admin</strong> accounts can access this panel.</div>
            </div>
            <div id="admin-toast" style="display:none;margin-top:16px;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;text-align:center;transition:0.3s;"></div>
        </div>
    </div>
</div>

<script>
// ====================== CONFIG ======================
const API_BASE = () => localStorage.getItem('flames_api') || 'https://flamesapp.up.railway.app';
const TOKEN    = () => localStorage.getItem('flames_token');
const authHeader = () => ({ 'Authorization': `Bearer ${TOKEN()}` });

if (!TOKEN()) window.location.href = 'login.html';

function decodeJWT(token) {
    try {
        const payload = token.split('.')[1];
        return JSON.parse(atob(payload.replace(/-/g,'+').replace(/_/g,'/')));
    } catch { return {}; }
}

(async () => {
    try {
        const res = await fetch(`${API_BASE()}/me`, { headers: authHeader() });
        if (res.status === 401) { window.location.href = 'login.html'; return; }
        const me = await res.json();
        document.getElementById('username-badge').textContent = me.username || '‚Äî';
        localStorage.setItem('flames_username', me.username);
        checkAdminAccess();
    } catch {
        document.getElementById('username-badge').textContent = localStorage.getItem('flames_username') || '‚Äî';
        checkAdminAccess();
    }
})();

async function checkAdminAccess() {
    try {
        const probeRes = await fetch(`${API_BASE()}/users/0`, { method: 'DELETE', headers: authHeader() });
        const isAdmin = probeRes.status === 404 || probeRes.status === 200;
        document.getElementById('admin-btn-label').textContent = isAdmin ? 'ADMIN' :
            (localStorage.getItem('flames_org_role') || 'MEMBER');
        window._flamesIsAdmin = isAdmin;
        document.getElementById('admin-btn').style.display = 'flex';
    } catch {}
}

// ====================== THEME ======================
const modeToggle = document.getElementById('mode-toggle');
const modeText = document.getElementById('mode-text');
function applyTheme(isDark) {
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    modeText.textContent = isDark ? 'Dark' : 'Light';
    modeToggle.checked = isDark;
}
modeToggle.addEventListener('change', () => {
    applyTheme(modeToggle.checked);
    localStorage.setItem('flames_theme', modeToggle.checked ? 'dark' : 'light');
});
applyTheme(localStorage.getItem('flames_theme') !== 'light');

// ====================== SIDE PANEL ======================
document.getElementById('profile-btn').addEventListener('click', () => {
    document.getElementById('side-panel').classList.add('active');
    document.getElementById('panel-overlay').classList.add('active');
});
function closePanel() {
    document.getElementById('side-panel').classList.remove('active');
    document.getElementById('panel-overlay').classList.remove('active');
}
document.getElementById('close-panel').addEventListener('click', closePanel);
document.getElementById('panel-overlay').addEventListener('click', closePanel);
document.getElementById('logout-trigger').addEventListener('click', () => {
    if (confirm('Are you sure you want to log out?')) window.location.href = 'index.html?action=logout';
});

// ====================== ADMIN MODAL ======================
function openAdminModal() {
    document.getElementById('admin-modal').style.display = 'flex';
    loadOrganizations();
    switchAdminTab('invite');
}
function closeAdminModal() {
    document.getElementById('admin-modal').style.display = 'none';
}
document.getElementById('admin-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAdminModal();
});
function switchAdminTab(tab) {
    document.getElementById('admin-panel-invite').style.display = tab === 'invite' ? 'block' : 'none';
    document.getElementById('admin-panel-users').style.display = tab === 'users' ? 'block' : 'none';
    document.getElementById('admin-panel-orgs').style.display = tab === 'orgs' ? 'block' : 'none';
    ['invite','users','orgs'].forEach(t => {
        const btn = document.getElementById(`admin-tab-${t}`);
        btn.style.background = t === tab ? 'linear-gradient(135deg,#8b1a00,#c43d00)' : '#2a0a0466';
        btn.style.color = t === tab ? 'white' : '#9a6a5a';
    });
}
async function loadOrganizations() {
    try {
        const res = await fetch(`${API_BASE()}/organizations`, { headers: authHeader() });
        if (!res.ok) throw new Error('Failed');
        const orgs = await res.json();
        const select = document.getElementById('admin-invite-org-select');
        select.innerHTML = '<option value="">Select Organization</option>';
        orgs.forEach(org => {
            const opt = document.createElement('option');
            opt.value = org.id;
            opt.textContent = `${org.name} (ID: ${org.id})`;
            select.appendChild(opt);
        });
        // populate orgs table
        const wrap = document.getElementById('admin-orgs-table');
        if (!orgs.length) { wrap.innerHTML = '<div style="color:#5a3a2a;text-align:center;padding:20px;">No organizations found.</div>'; return; }
        wrap.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead><tr style="border-bottom:1px solid #4a1a0a55;">
                <th style="text-align:left;padding:8px 10px;color:#9a6a5a;font-size:10px;">ID</th>
                <th style="text-align:left;padding:8px 10px;color:#9a6a5a;font-size:10px;">Name</th>
            </tr></thead><tbody>
            ${orgs.map(o=>`<tr style="border-bottom:1px solid #3a1a0a33;">
                <td style="padding:8px 10px;color:#5a3a2a;font-family:monospace;">${o.id}</td>
                <td style="padding:8px 10px;color:#f0d0b8;font-weight:600;">${o.name}</td>
            </tr>`).join('')}
            </tbody></table>`;
    } catch (err) { console.error(err); }
}
async function adminGenerateInvite() {
    const orgId = document.getElementById('admin-invite-org-select').value;
    const expires = parseInt(document.getElementById('admin-invite-expires').value) || 30;
    const maxUses = parseInt(document.getElementById('admin-invite-max-uses').value) || 1;
    if (!orgId) { adminToast('Please select an organization', 'error'); return; }
    try {
        const res = await fetch(`${API_BASE()}/organizations/${orgId}/invite-codes`, {
            method: 'POST', headers: { ...authHeader(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ expires_days: expires, max_uses: maxUses })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');
        document.getElementById('admin-invite-code-display').textContent = data.code;
        const expDate = data.expires_at ? new Date(data.expires_at).toLocaleDateString() : 'Never';
        document.getElementById('admin-invite-meta').textContent = `Expires: ${expDate} ‚Ä¢ Max uses: ${data.max_uses === 0 ? 'Unlimited' : data.max_uses}`;
        document.getElementById('admin-copy-code-btn').dataset.code = data.code;
        document.getElementById('admin-invite-result').style.display = 'block';
        adminToast('Invite code generated!', 'success');
    } catch (err) { adminToast(err.message, 'error'); }
}
function adminCopyCode() {
    const code = document.getElementById('admin-copy-code-btn').dataset.code;
    if (code) { navigator.clipboard.writeText(code); adminToast('Code copied!', 'success'); }
}
async function adminDeleteInvite() {
    const code = (document.getElementById('admin-delete-invite-input').value || '').trim().toUpperCase();
    if (!code) { adminToast('Enter an invite code', 'error'); return; }
    if (!confirm(`Delete "${code}"?`)) return;
    try {
        const res = await fetch(`${API_BASE()}/invite-codes/${code}`, { method: 'DELETE', headers: authHeader() });
        if (!res.ok) throw new Error(await res.text());
        adminToast(`Code "${code}" deleted`, 'success');
        document.getElementById('admin-delete-invite-input').value = '';
    } catch (err) { adminToast(err.message, 'error'); }
}
async function adminCreateOrganization() {
    const name = document.getElementById('admin-create-org-name').value.trim();
    const expires = parseInt(document.getElementById('admin-create-org-expires').value) || 30;
    if (!name) { adminToast('Enter organization name', 'error'); return; }
    try {
        const res = await fetch(`${API_BASE()}/organizations`, {
            method: 'POST', headers: { ...authHeader(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, invite_code_expires_days: expires })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');
        document.getElementById('admin-create-org-name-display').textContent = name;
        document.getElementById('admin-create-org-meta').textContent = `ID: ${data.id}`;
        document.getElementById('admin-create-org-result').style.display = 'block';
        adminToast('Organization created!', 'success');
        loadOrganizations();
    } catch (err) { adminToast(err.message, 'error'); }
}
function adminToast(msg, type = 'info') {
    const el = document.getElementById('admin-toast');
    el.textContent = msg;
    const colors = {
        success: { bg:'#0a160a', border:'#2ecc7155', color:'#2ecc71' },
        error:   { bg:'#160a0a', border:'#ff475755', color:'#ff4757' },
        info:    { bg:'#120e04', border:'#f1c40f55', color:'#f1c40f' }
    };
    const c = colors[type] || colors.info;
    el.style.background = c.bg; el.style.border = `1px solid ${c.border}`; el.style.color = c.color;
    el.style.display = 'block';
    clearTimeout(el._t);
    el._t = setTimeout(() => el.style.display = 'none', 3500);
}
async function adminLoadUsers() {
    const wrap = document.getElementById('admin-users-table');
    wrap.innerHTML = '<div style="color:#9a6a5a;text-align:center;padding:20px;">Loading‚Ä¶</div>';
    try {
        const res = await fetch(`${API_BASE()}/users`, { headers: authHeader() });
        if (res.status === 404 || res.status === 405) {
            wrap.innerHTML = `<div style="text-align:center;padding:24px;"><div style="color:#f1c40f;font-size:13px;">GET /users not available on this backend.</div></div>`;
            return;
        }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const users = await res.json();
        if (!users.length) { wrap.innerHTML = '<div style="color:#5a3a2a;text-align:center;padding:20px;">No users found.</div>'; return; }
        wrap.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead><tr style="border-bottom:1px solid #4a1a0a55;">
                <th style="text-align:left;padding:8px 10px;color:#9a6a5a;font-size:10px;">ID</th>
                <th style="text-align:left;padding:8px 10px;color:#9a6a5a;font-size:10px;">Username</th>
                <th style="text-align:left;padding:8px 10px;color:#9a6a5a;font-size:10px;">Role</th>
                <th style="padding:8px 10px;"></th>
            </tr></thead><tbody>
            ${users.map(u=>`<tr style="border-bottom:1px solid #3a1a0a33;">
                <td style="padding:8px 10px;color:#5a3a2a;font-family:monospace;">${u.id}</td>
                <td style="padding:8px 10px;color:#f0d0b8;font-weight:600;">${u.username}</td>
                <td style="padding:8px 10px;"><span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${u.is_admin?'#3a0a0066':'#1a0a0466'};border:1px solid ${u.is_admin?'#e14f0055':'#4a1a0a55'};color:${u.is_admin?'#ff7733':'#9a6a5a'};">${u.is_admin?'ADMIN':'MEMBER'}</span></td>
                <td style="padding:8px 10px;text-align:right;"><button onclick="adminDeleteUserById(${u.id},'${u.username}')" style="padding:4px 10px;background:#1a000066;border:1px solid #ff475755;border-radius:6px;color:#ff4757;font-size:10px;cursor:pointer;font-family:'Cinzel',serif;" onmouseover="this.style.background='#ff475722'" onmouseout="this.style.background='#1a000066'">Delete</button></td>
            </tr>`).join('')}
            </tbody></table>`;
    } catch(e) { wrap.innerHTML = `<div style="color:#ff4757;text-align:center;padding:20px;">${e.message}</div>`; }
}
async function adminDeleteUser() {
    const id = parseInt(document.getElementById('admin-delete-user-input').value);
    if (!id || isNaN(id)) { adminToast('Enter a valid User ID', 'error'); return; }
    await adminDeleteUserById(id, `ID ${id}`);
    document.getElementById('admin-delete-user-input').value = '';
}
async function adminDeleteUserById(id, name) {
    if (!confirm(`Delete user "${name}" (ID: ${id})?`)) return;
    try {
        const res = await fetch(`${API_BASE()}/users/${id}`, { method: 'DELETE', headers: authHeader() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Delete failed');
        adminToast(`User "${name}" deleted`, 'success');
        adminLoadUsers();
    } catch(e) { adminToast(e.message, 'error'); }
}

// ====================== MAP ======================
const MAP_CENTER = [16.0435, 120.3351];
const GATEWAY = { lat: 16.046962, lng: 120.342117 };

const map = L.map('flames-map', { zoomControl: false, attributionControl: false }).setView(MAP_CENTER, 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

document.getElementById('home-btn').addEventListener('click', () => map.flyTo(MAP_CENTER, 14));
document.getElementById('locate-btn').addEventListener('click', () => {
    navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 16), () => alert('Location access denied.'));
});
document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());

const greenIcon  = L.icon({ iconUrl: 'icons/StartingPoint.png', iconSize: [60,60], iconAnchor:[30,55], popupAnchor:[0,-60] });
const redIcon    = L.icon({ iconUrl: 'icons/EndPoint.png',      iconSize: [60,60], iconAnchor:[30,55], popupAnchor:[0,-60] });
const nodeIcon   = L.icon({ iconUrl: 'icons/Node.png',          iconSize: [50,50], iconAnchor:[18,18] });
const gwIcon     = L.icon({ iconUrl: 'icons/Gateway.png',       iconSize: [55,55], iconAnchor:[20,20] });
const fireIcon   = L.icon({ iconUrl: 'icons/FireIncident.png',  iconSize: [30,30], iconAnchor:[15,15] });

L.marker([GATEWAY.lat, GATEWAY.lng], { icon: gwIcon }).addTo(map).bindPopup('<b>üè† F.L.A.M.E.S. Gateway</b>');

let nodeMarkers = {};
let nodeData = {};
let selectedNodeId = null;
let pinnedLocations = [];
let pinnedMarkers = {};

const OFFLINE_THRESHOLD_MINUTES = 5;
const COLOR_RED = '#ff4757';
const COLOR_GREEN = '#2ecc71';
const COLOR_ORANGE = '#ff9f1c';
const COLOR_NORMAL = '#ff904f';

async function loadAndPlaceNodes(silent = false) {
    try {
        const res = await fetch(`${API_BASE()}/nodes`, { headers: authHeader(), cache: silent ? 'default' : 'no-cache' });
        if (res.status === 401) { window.location.href = 'login.html'; return; }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const nodes = await res.json();
        if (!nodes || nodes.length === 0) { if (!silent) alert('No sensor nodes available.'); return; }

        Object.keys(nodeMarkers).forEach(id => {
            if (!nodes.some(n => n.node_id === id)) { map.removeLayer(nodeMarkers[id]); delete nodeMarkers[id]; delete nodeData[id]; }
        });

        const gatewayLat = 16.046962, gatewayLng = 120.342117;
        nodes.forEach(n => {
            const node_id = n.node_id;
            let lat = parseFloat(n.latitude), lng = parseFloat(n.longitude);
            const hasValid = !isNaN(lat) && lat !== 0 && !isNaN(lng) && lng !== 0;
            if (!hasValid) { lat = nodeData[node_id]?.latitude; lng = nodeData[node_id]?.longitude; }
            let isUsingFallback = false;
            if (lat == null || lng == null || isNaN(lat) || isNaN(lng)) {
                const offsetM = 10 + Math.random() * 90, angle = Math.random() * 2 * Math.PI;
                lat = gatewayLat + (offsetM / 111000) * Math.cos(angle);
                lng = gatewayLng + (offsetM / (111000 * Math.cos(gatewayLat * Math.PI / 180))) * Math.sin(angle);
                isUsingFallback = true;
            }
            const lastUpdated = n.updated_at || n.last_seen || new Date().toISOString();
            nodeData[node_id] = { ...nodeData[node_id] || {}, ...n, latitude: lat, longitude: lng, last_updated: lastUpdated, isUsingFallbackPosition: isUsingFallback };

            const lastTime = new Date(lastUpdated);
            const minutesAgo = (Date.now() - lastTime.getTime()) / 1000 / 60;
            const isOffline = minutesAgo > OFFLINE_THRESHOLD_MINUTES;
            const pred = (n.ai_prediction || "normal").toLowerCase();
            const conf = n.confidence != null ? Number(n.confidence) : 0;
            const isFire = pred === "fire", isHighConf = conf >= 0.70;
            const statusColor = isFire ? (isHighConf ? '#ff4757' : '#ff9f1c') : '#2ecc71';
            const statusLabel = isFire ? (isHighConf ? 'üî• FIRE' : 'Possible Fire') : 'Normal';
            const lastOnlineStr = lastTime.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const positionNote = isUsingFallback ? `<div style="color:#ff9f1c;font-size:11px;margin-top:6px;">(Approximate position near gateway)</div>` : '';

            const popupContent = `
                <div class="popup-title">üì° ${node_id}</div>
                ${isOffline ? `<div style="color:${COLOR_ORANGE};font-weight:600;margin:8px 0;">‚ö† OFFLINE<br>Last online: ${lastOnlineStr}</div>` : ''}
                ${positionNote}
                <div style="font-size:13px;color:#9a6a5a;line-height:1.7;">
                    Temp: <b style="color:${COLOR_NORMAL}">${n.temperature ?? '‚Äî'}¬∞C</b><br>
                    Hum:  <b style="color:${COLOR_NORMAL}">${n.humidity ?? '‚Äî'}%</b><br>
                    Flame: <b style="color:${COLOR_NORMAL}">${n.flame ?? '‚Äî'}</b><br>
                    Smoke: <b style="color:${COLOR_NORMAL}">${n.smoke ?? '‚Äî'} ppm</b><br>
                    AI: <strong>${pred.toUpperCase()}</strong> (${(conf * 100).toFixed(1)}%)
                    <b style="color:${statusColor}">${statusLabel}</b>
                    ${!isOffline ? `<br><small>Last update: ${lastOnlineStr}</small>` : ''}
                </div>
            `;

            if (nodeMarkers[node_id]) {
                nodeMarkers[node_id].setLatLng([lat, lng]);
                nodeMarkers[node_id].setPopupContent(popupContent);
                nodeMarkers[node_id].getElement().style.opacity = isOffline ? 0.55 : 1.0;
            } else {
                const marker = L.marker([lat, lng], { icon: nodeIcon, opacity: isOffline ? 0.55 : 1.0 }).addTo(map);
                marker.bindPopup(popupContent);
                marker.on('click', () => { selectedNodeId = node_id; updateSensorBar(nodeData[node_id], node_id); });
                nodeMarkers[node_id] = marker;
            }
        });

        if (selectedNodeId && nodeData[selectedNodeId]) updateSensorBar(nodeData[selectedNodeId], selectedNodeId);
    } catch (err) {
        console.error('Failed to load nodes:', err);
        if (!silent) alert('Could not load sensor nodes.');
    }
}

loadAndPlaceNodes();
setInterval(() => loadAndPlaceNodes(true), 15000);

// ====================== WEBSOCKET ======================
function connectWebSocket() {
    const wsUrl = API_BASE().replace(/^http/, 'ws') + '/ws';
    const ws = new WebSocket(wsUrl);
    const dot = document.getElementById('ws-dot'), label = document.getElementById('ws-label');
    ws.onopen = () => { dot.className = 'ws-dot connected'; label.textContent = 'Live'; };
    ws.onclose = () => { dot.className = 'ws-dot error'; label.textContent = 'Disconnected'; setTimeout(connectWebSocket, 5000); };
    ws.onerror = () => { dot.className = 'ws-dot error'; label.textContent = 'Error'; };
    ws.onmessage = (event) => {
        try {
            const msg = JSON.parse(event.data);
            loadAndPlaceNodes(true);
            if (msg.type === "incident_update") loadLiveIncidents(true);
        } catch {}
    };
}
connectWebSocket();

// ====================== SENSOR BAR ======================
function updateSensorBar(d, nodeId) {
    document.getElementById('sb-temp').textContent = d.temperature != null ? `${d.temperature}¬∞C` : '‚Äî';
    document.getElementById('sb-hum').textContent = d.humidity != null ? `${d.humidity}%` : '‚Äî';
    document.getElementById('sb-smoke').textContent = d.smoke != null ? `${d.smoke} ppm` : '‚Äî';
    document.getElementById('sb-flame').textContent = d.flame != null ? d.flame : '‚Äî';
    ['sb-temp','sb-hum','sb-smoke','sb-flame'].forEach(id => document.getElementById(id).className = 'sensor-tile-val');
    const pred = (d.ai_prediction || "normal").toLowerCase();
    const conf = d.confidence != null ? Number(d.confidence) : 0;
    if (pred === "fire" && conf >= 0.70) {
        document.getElementById('sb-smoke').className += ' alert';
        document.getElementById('sb-flame').className += ' alert';
    }
    const lastUpdated = d.last_updated ? new Date(d.last_updated) : null;
    const isOffline = lastUpdated && (Date.now() - lastUpdated.getTime()) / 1000 / 60 > OFFLINE_THRESHOLD_MINUTES;
    document.getElementById('sb-node-label').innerHTML = nodeId ? `${nodeId}${isOffline ? ' <small style="color:#ff9f1c;">(offline)</small>' : ''}` : 'No node';
    const offlineStyle = isOffline ? 'opacity:0.6; font-style:italic;' : '';
    ['sb-temp','sb-hum','sb-smoke','sb-flame'].forEach(id => document.getElementById(id).style = offlineStyle);
}

// ====================== PINNED LOCATIONS ======================
function renderPinned() {
    document.getElementById('pinned-count').textContent = pinnedLocations.length;
    const list = document.getElementById('pinned-list');
    const noMsg = document.getElementById('no-pinned-msg');
    list.querySelectorAll('.pinned-item').forEach(i => i.remove());
    noMsg.style.display = pinnedLocations.length ? 'none' : 'block';
    Object.values(pinnedMarkers).forEach(m => map.removeLayer(m));
    pinnedMarkers = {};
    pinnedLocations.forEach(pin => {
        const item = document.createElement('div');
        item.className = 'pinned-item';
        item.innerHTML = `
            <div>
                <div class="pinned-item-name">${pin.name || 'Pinned Location'}</div>
                <div class="pinned-item-coords">${pin.latitude.toFixed(6)}, ${pin.longitude.toFixed(6)}</div>
            </div>
            <div class="pinned-item-actions">
                <button class="btn-icon-sm" onclick="flyToPin(${pin.latitude}, ${pin.longitude})" title="Go to">üìç</button>
                <button class="btn-icon-sm" onclick="removePin(${pin.id})" title="Remove" style="color:var(--red)">‚úï</button>
            </div>`;
        list.appendChild(item);
        const marker = L.marker([pin.latitude, pin.longitude]).addTo(map)
            .bindPopup(`<b>${pin.name || 'Pinned'}</b><br>${pin.latitude.toFixed(6)}, ${pin.longitude.toFixed(6)}`);
        pinnedMarkers[pin.id] = marker;
    });
}
let pinnedListVisible = false;
function togglePinnedList() {
    pinnedListVisible = !pinnedListVisible;
    document.getElementById('pinned-list').classList.toggle('visible', pinnedListVisible);
    document.getElementById('pinned-count-view').style.display = pinnedListVisible ? 'none' : 'flex';
}
renderPinned();
async function loadPinnedLocations() {
    try {
        const res = await fetch(`${API_BASE()}/me/pins`, { headers: authHeader(), cache: 'no-cache' });
        if (res.status === 401) { window.location.href = 'login.html'; return; }
        if (!res.ok) { console.warn('Pins fetch failed:', res.status); return; }
        pinnedLocations = await res.json();
        renderPinned();
    } catch (err) { console.error('Failed to load pins:', err); }
}
async function savePin(lat, lng) {
    const name = document.getElementById('pin-name')?.value.trim() || null;
    try {
        const res = await fetch(`${API_BASE()}/me/pins`, {
            method: 'POST', headers: { ...authHeader(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, latitude: lat, longitude: lng })
        });
        if (!res.ok) throw new Error(await res.text());
        map.closePopup();
        await loadPinnedLocations();
    } catch (err) { console.error(err); alert('Could not save pin.'); }
}
async function removePin(pinId) {
    try {
        const res = await fetch(`${API_BASE()}/me/pins/${pinId}`, { method: 'DELETE', headers: authHeader() });
        if (!res.ok) throw new Error(await res.text());
        await loadPinnedLocations();
    } catch (err) { console.error(err); alert('Could not delete pin.'); }
}
function flyToPin(lat, lng) { map.flyTo([lat, lng], 16); }
loadPinnedLocations();

let pendingPopup = null;
map.on('contextmenu', function(e) {
    e.originalEvent.preventDefault();
    if (pendingPopup) { map.closePopup(pendingPopup); pendingPopup = null; }
    const lat = e.latlng.lat.toFixed(6), lng = e.latlng.lng.toFixed(6);
    const popup = L.popup({ maxWidth: 260 })
        .setLatLng(e.latlng)
        .setContent(`
            <div class="popup-title">üìç Pin this location?</div>
            <div class="popup-coords">${lat}, ${lng}</div>
            <input class="popup-input" id="pin-name" placeholder="Location name (optional)">
            <div class="popup-actions">
                <button class="popup-save" onclick="savePin(${lat}, ${lng})">Save</button>
                <button class="popup-cancel" onclick="map.closePopup()">Cancel</button>
            </div>
        `).addTo(map);
    pendingPopup = popup;
    popup.on('remove', () => { pendingPopup = null; });
});

// ====================== SEARCH ======================
let searchTimeout;
async function handleSearch(val) {
    const clrBtn = document.getElementById('clearSearch');
    const searchIcon = document.getElementById('search-icon-img');
    const box = document.getElementById('suggestionsBox');
    clrBtn.style.display = val ? 'block' : 'none';
    searchIcon.style.display = val ? 'none' : 'block';
    if (!val) { box.style.display = 'none'; return; }
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=5&countrycodes=ph`);
            const data = await res.json();
            box.innerHTML = '';
            if (!data.length) { box.style.display = 'none'; return; }
            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'suggestion-item';
                el.textContent = item.display_name;
                el.onclick = () => {
                    map.flyTo([item.lat, item.lon], 16);
                    document.getElementById('mapSearchInput').value = item.display_name;
                    box.style.display = 'none';
                    clrBtn.style.display = 'block';
                    searchIcon.style.display = 'none';
                };
                box.appendChild(el);
            });
            box.style.display = 'block';
        } catch {}
    }, 400);
}
function clearSearchInput() {
    document.getElementById('mapSearchInput').value = '';
    document.getElementById('suggestionsBox').style.display = 'none';
    document.getElementById('clearSearch').style.display = 'none';
    document.getElementById('search-icon-img').style.display = 'block';
}

// ====================== ROUTE PLANNER ======================
let routingControl = null, waypoints = [], routeMarkers = [];
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImEyYTEzN2QzOGRlNzQzNzQ5MTMwZTg1NzVkMTJlMzFiIiwiaCI6Im11cm11cjY0In0=';

document.getElementById('route-btn').addEventListener('click', () => {
    document.getElementById('route-menu').classList.toggle('visible');
});
document.getElementById('calc-route').addEventListener('click', () => {
    if (waypoints.length === 2) { calculateRoute(waypoints[0], waypoints[1]); document.getElementById('route-menu').classList.remove('visible'); }
    else { alert('Click to place Start Point (green), then End Point (red).'); waypoints = []; routeMarkers.forEach(m => map.removeLayer(m)); routeMarkers = []; if (routingControl) { map.removeLayer(routingControl); routingControl = null; } }
});
document.getElementById('clear-route').addEventListener('click', () => {
    if (routingControl) { map.removeLayer(routingControl); routingControl = null; }
    routeMarkers.forEach(m => map.removeLayer(m)); routeMarkers = []; waypoints = [];
    document.getElementById('route-info-box').style.display = 'none';
    document.getElementById('route-menu').classList.remove('visible');
});
document.getElementById('close-info-btn').addEventListener('click', () => {
    if (routingControl) { map.removeLayer(routingControl); routingControl = null; }
    routeMarkers.forEach(m => map.removeLayer(m)); routeMarkers = []; waypoints = [];
    document.getElementById('route-info-box').style.display = 'none';
});
map.on('click', function(e) {
    if (waypoints.length < 2) {
        waypoints.push(e.latlng);
        const marker = L.marker(e.latlng, { icon: waypoints.length === 1 ? greenIcon : redIcon }).addTo(map);
        routeMarkers.push(marker);
    }
});
async function calculateRoute(start, end) {
    // ////////////////////////////////////////////////////////////////////
    // // CH ALGORITHM PART START
    // Using POST /geojson with simple parameters to trigger the 
    // Contraction Hierarchies (CH) pre-calculated shortcut graph.
    const url = `https://api.openrouteservice.org/v2/directions/driving-car/geojson`;
    
    const requestBody = {
        "coordinates": [[start.lng, start.lat], [end.lng, end.lat]],
        "preference": "fastest",
        "units": "m"
    };
    // // CH ALGORITHM PART END
    // ////////////////////////////////////////////////////////////////////

    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': ORS_API_KEY
            },
            body: JSON.stringify(requestBody)
        });

        if (!res.ok) throw new Error('Routing API error');
        const data = await res.json();
        
        // Log calculation speed to verify CH performance
        console.log(`üî• Fire Truck Route Found (CH Algorithm): ${data.metadata.query.processing_time}ms`);
        
        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        const summary = data.features[0].properties.summary;
        
        if (routingControl) map.removeLayer(routingControl);
        
        // Priority styling for Fire Truck (Emergency Red-Orange)
        routingControl = L.polyline(coords, { 
            color: '#ff3300', 
            weight: 6, 
            opacity: 0.9,
            dashArray: '1, 10' // Optional: Gives a pulse/urgent look
        }).addTo(map);
        
        const dist = (summary.distance / 1000).toFixed(2), time = Math.round(summary.duration / 60);
        
        document.getElementById('route-info-box').style.display = 'flex';
        document.getElementById('route-dist').innerHTML = `<img src="icons/distance.png"> ${dist} km`;
        document.getElementById('route-time').innerHTML = `<img src="icons/minutes.png"> ~${time} min`;
        
        map.fitBounds(routingControl.getBounds());
    } catch { 
        alert('Routing failed. No road available.'); 
    }
}
function routeToIncident(lat, lng) {
    waypoints = [GATEWAY, { lat, lng }];
    const m1 = L.marker([GATEWAY.lat, GATEWAY.lng], { icon: greenIcon }).addTo(map);
    const m2 = L.marker([lat, lng], { icon: redIcon }).addTo(map);
    routeMarkers.push(m1, m2);
    calculateRoute(GATEWAY, { lat, lng });
    map.flyTo([lat, lng], 14);
}

// ====================== LIVE INCIDENTS ======================
async function loadLiveIncidents(silent = false) {
    try {
        const res = await fetch(`${API_BASE()}/incidents/active`, { headers: authHeader(), cache: 'no-cache' });
        if (res.status === 401) { window.location.href = 'login.html'; return; }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const incidents = await res.json();
        const listEl = document.getElementById('incident-list');
        listEl.innerHTML = '';
        if (incidents.length === 0) {
            listEl.innerHTML = '<div class="node-placeholder">No active incidents right now</div>';
        } else {
            incidents.forEach(inc => {
                const confColor = inc.confidence_pct >= 70 ? 'var(--green)' : (inc.confidence_pct >= 40 ? 'var(--yellow)' : 'var(--orange-offline)');
                listEl.innerHTML += `
                    <div class="incident-card">
                        <div class="incident-title">${inc.location_name || `Node ${inc.node_id}`}</div>
                        <div class="incident-meta">Status: <span class="${inc.status_class}">${inc.status}</span></div>
                        <div class="incident-meta">AI: <strong>${inc.ai_prediction}</strong> <span style="color:${confColor};font-weight:600;">(${inc.confidence_pct}%)</span></div>
                        <div class="incident-meta">Last reading: ${inc.timestamp}</div>
                        ${inc.assigned_team ? `<div class="incident-meta">Team: ${inc.assigned_team}</div>` : ''}
                        <button class="btn-route" onclick="routeToIncident(${inc.latitude}, ${inc.longitude})">üî• Show on Map & Route</button>
                    </div>`;
            });
        }
        document.getElementById('incident-count').textContent = incidents.length;
        const now = new Date();
        document.getElementById('incidents-last-update').textContent = `Last updated: ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    } catch (err) {
        console.error('Failed to load incidents:', err);
        if (!silent) document.getElementById('incident-list').innerHTML = '<div class="node-placeholder">Error loading incidents</div>';
    }
}
loadLiveIncidents();
setInterval(() => loadLiveIncidents(true), 20000);

// ====================== INLINE HISTORY PANEL ======================
let _hm_node = null;
let _hm_limit = 50;

function openHistoryPanel(nodeId) {
    _hm_node = nodeId;
    _hm_metric = 'temperature';
    _hm_rows_cache = [];
    document.getElementById('hp-node-id').textContent = nodeId;
    document.getElementById('hp-record-count').textContent = '0 readings';
    // Reset limit buttons
    document.querySelectorAll('.hp-limit-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.hp-limit-btn')[1].classList.add('active');
    _hm_limit = 50;
    // Reset chart tabs to Temperature
    document.querySelectorAll('.hp-chart-tab').forEach(b => b.classList.toggle('active', b.dataset.metric === 'temperature'));
    document.getElementById('hp-chart-label').textContent = CHART_METRICS['temperature'].label;
    // Switch views
    document.getElementById('right-default-view').classList.add('hidden');
    document.getElementById('right-history-view').classList.add('visible');
    // Fetch data
    fetchHistory();
}

function closeHistoryPanel() {
    document.getElementById('right-history-view').classList.remove('visible');
    document.getElementById('right-default-view').classList.remove('hidden');
    _hm_node = null;
    _hm_rows_cache = [];
    // Reset table
    document.getElementById('hp-table-body').innerHTML = `<div class="hp-state"><div>Select a node to view its history</div></div>`;
    document.getElementById('hp-stats').innerHTML = '';
    document.getElementById('hp-record-count').textContent = '0 readings';
    renderSparkline([]);
}

function setHistoryLimit(n) {
    _hm_limit = n;
    document.querySelectorAll('.hp-limit-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.textContent) === n);
    });
    fetchHistory();
}

function refreshHistory() {
    const btn = document.getElementById('hp-refresh-btn');
    btn.classList.add('spinning');
    fetchHistory().finally(() => setTimeout(() => btn.classList.remove('spinning'), 500));
}

async function fetchHistory() {
    if (!_hm_node) return;
    const bodyEl = document.getElementById('hp-table-body');
    bodyEl.innerHTML = `<div class="hp-state"><div class="hp-spinner"></div>Loading‚Ä¶</div>`;
    document.getElementById('hp-stats').innerHTML = '';
    renderSparkline([]);
    try {
        const res = await fetch(`${API_BASE()}/history/${encodeURIComponent(_hm_node)}?limit=${_hm_limit}`, { headers: authHeader(), cache: 'no-cache' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();
        // DEBUG: log the first row so we can see exact field names from the API
        if (rows.length > 0) console.log('History row sample:', JSON.stringify(rows[0]));
        document.getElementById('hp-record-count').textContent = `${rows.length} readings`;
        if (!rows.length) { bodyEl.innerHTML = `<div class="hp-state">No history for node <strong>${_hm_node}</strong>.</div>`; return; }
        renderStats(rows);
        renderSparkline(rows);
        renderTable(rows);
    } catch(err) {
        bodyEl.innerHTML = `<div class="hp-state" style="color:#ff4757;">‚ö† Failed: ${err.message}</div>`;
    }
}

function renderStats(rows) {
    const temps  = rows.map(r => r.temperature).filter(v => v != null);
    const smokes = rows.map(r => r.smoke).filter(v => v != null);
    const hums   = rows.map(r => r.humidity).filter(v => v != null);
    const fires  = rows.filter(r => r.ai_prediction === 'fire').length;
    const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '‚Äî';
    const max = arr => arr.length ? Math.max(...arr).toFixed(1) : '‚Äî';
    document.getElementById('hp-stats').innerHTML = `
        <div class="hp-stat"><span class="hp-stat-label">AVG TEMP</span><span class="hp-stat-val">${avg(temps)}¬∞C</span></div>
        <div class="hp-stat"><span class="hp-stat-label">MAX TEMP</span><span class="hp-stat-val">${max(temps)}¬∞C</span></div>
        <div class="hp-stat"><span class="hp-stat-label">AVG SMOKE</span><span class="hp-stat-val">${avg(smokes)} ppm</span></div>
        <div class="hp-stat"><span class="hp-stat-label">AVG HUM</span><span class="hp-stat-val">${avg(hums)}%</span></div>
        <div class="hp-stat" style="${fires>0?'border-color:#ff475577;':''}">
            <span class="hp-stat-label">üî• FIRE EVENTS</span>
            <span class="hp-stat-val" style="${fires>0?'color:#ff4757;':''}">${fires}</span>
        </div>`;
}

// Chart metric state
let _hm_metric = 'temperature';
let _hm_rows_cache = [];

const CHART_METRICS = {
    temperature: { label: 'Temperature Trend (¬∞C)',  unit: '¬∞C',  color: '#ff6b35', key: 'temperature' },
    humidity:    { label: 'Humidity Trend (%)',       unit: '%',   color: '#3d9cff', key: 'humidity'    },
    smoke:       { label: 'Smoke Trend (ppm)',        unit: ' ppm',color: '#c8c8c8', key: 'smoke'       },
    flame:       { label: 'Flame Sensor Trend',       unit: '',    color: '#ff4757', key: 'flame'       },
};

function switchChartMetric(metric) {
    _hm_metric = metric;
    // Update tab active states
    document.querySelectorAll('.hp-chart-tab').forEach(b => {
        b.classList.toggle('active', b.dataset.metric === metric);
    });
    // Update label
    document.getElementById('hp-chart-label').textContent = CHART_METRICS[metric].label;
    // Re-render chart with cached rows
    renderSparkline(_hm_rows_cache);
}

function renderSparkline(rows) {
    _hm_rows_cache = rows;
    const svg = document.getElementById('hp-chart-svg');
    const cfg = CHART_METRICS[_hm_metric];
    const vals = [...rows].reverse().map(r => r[cfg.key]).filter(v => v != null && v !== undefined);

    if (vals.length < 2) {
        svg.innerHTML = `<text x="400" y="38" text-anchor="middle" fill="#3a1a0a" font-size="12">Not enough data</text>`;
        return;
    }

    const W = 800, H = 70, PAD = 6;
    const rawMin = Math.min(...vals), rawMax = Math.max(...vals);
    const range = rawMax - rawMin;
    const min = rawMin - (range * 0.1 || 1);
    const max = rawMax + (range * 0.1 || 1);

    const px = i => PAD + (i / (vals.length - 1)) * (W - PAD * 2);
    const py = v => PAD + (1 - (v - min) / (max - min)) * (H - PAD * 2);
    const pts = vals.map((v, i) => `${px(i)},${py(v)}`).join(' ');
    const areaD = `M${px(0)},${H} ` + vals.map((v, i) => `L${px(i)},${py(v)}`).join(' ') + ` L${px(vals.length - 1)},${H} Z`;
    const lineCol = cfg.color;

    svg.innerHTML = `
        <defs><linearGradient id="hp-area-grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="${lineCol}" stop-opacity="0.3"/>
            <stop offset="100%" stop-color="${lineCol}" stop-opacity="0.02"/>
        </linearGradient></defs>
        <path d="${areaD}" fill="url(#hp-area-grad)"/>
        <polyline points="${pts}" fill="none" stroke="${lineCol}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
        <circle cx="${px(vals.length - 1)}" cy="${py(vals[vals.length - 1])}" r="3.5" fill="${lineCol}" opacity="0.9"/>
        <text x="${PAD + 2}" y="${H - 3}" fill="#4a2a1a" font-size="9">${rawMin.toFixed(1)}${cfg.unit}</text>
        <text x="${PAD + 2}" y="13" fill="#4a2a1a" font-size="9">${rawMax.toFixed(1)}${cfg.unit}</text>`;
}

function formatTimestamp(raw) {
    if (!raw) return '‚Äî';
    // raw is like "2026-02-20 04:34:30" ‚Äî parse as local time
    const s = raw.toString().replace('T', ' ').replace(/\.\d+Z?$/, '');
    const [datePart, timePart] = s.split(' ');
    if (!datePart) return raw;
    const [year, month, day] = datePart.split('-');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const monthName = months[parseInt(month, 10) - 1] || month;
    return `${monthName} ${parseInt(day, 10)}, ${timePart || ''}`;
}

function renderTable(rows) {
    document.getElementById('hp-table-body').innerHTML = `
        <table class="hp-table">
            <colgroup>
                <col style="width:28px"><col style="width:108px"><col style="width:60px">
                <col style="width:50px"><col style="width:55px"><col style="width:50px">
                <col style="width:62px"><col style="width:54px"><col style="width:44px">
            </colgroup>
            <thead><tr>
                <th>#</th><th>Timestamp</th><th>Temp ¬∞C</th>
                <th>Hum %</th><th>Smoke</th><th>Flame</th>
                <th>AI</th><th>Conf.</th><th>RSSI</th>
            </tr></thead>
            <tbody>
                ${rows.map((r, i) => {
                    // Use exact MySQL column names: ai_prediction, confidence
                    const rawPred = r.ai_prediction || '';
                    const pred = rawPred.toLowerCase();
                    // confidence is 0‚Äì1 in MySQL (e.g. 1 = 100%), multiply by 100
                    const confRaw = r.confidence != null ? parseFloat(r.confidence) : null;
                    const confPct = confRaw != null ? (confRaw <= 1 ? confRaw * 100 : confRaw) : null;
                    const confStr = confPct != null ? confPct.toFixed(1) : '‚Äî';
                    const confColor = confPct != null
                        ? (confPct >= 70 ? '#2ecc71' : confPct >= 40 ? '#f1c40f' : '#ff9f1c')
                        : '#5a3a2a';
                    const aiBadge = pred === 'fire'
                        ? `<span class="ai-badge ai-fire">üî• Fire</span>`
                        : (pred === 'normal')
                            ? `<span class="ai-badge ai-normal">Normal</span>`
                            : rawPred
                                ? `<span class="ai-badge ai-unknown">${rawPred}</span>`
                                : `<span style="color:#5a3a2a;">‚Äî</span>`;
                    const ts = formatTimestamp(r.local_timestamp || r.timestamp);
                    return `<tr>
                        <td style="color:#3a2a1a;font-size:10px;">${i+1}</td>
                        <td class="hp-time">${ts}</td>
                        <td class="hp-num">${r.temperature ?? '‚Äî'}</td>
                        <td class="hp-num">${r.humidity ?? '‚Äî'}</td>
                        <td class="hp-num">${r.smoke ?? '‚Äî'}</td>
                        <td class="hp-num">${r.flame ?? '‚Äî'}</td>
                        <td>${aiBadge}</td>
                        <td style="color:${confColor};font-weight:600;font-family:monospace;">${confStr}%</td>
                        <td style="color:#5a3a2a;font-family:monospace;">${r.rssi ?? '‚Äî'}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>`;
}

// ====================== NODE POPUP ‚Üí HISTORY BUTTON ======================
// Inject "View History" button into every node popup when it opens
map.on('popupopen', function(e) {
    const container = e.popup.getElement();
    if (!container) return;
    const titleEl = container.querySelector('.popup-title');
    if (!titleEl) return;
    const match = (titleEl.textContent || '').match(/üì°\s*(.+)/);
    if (!match) return;
    const nodeId = match[1].trim();
    if (container.querySelector('.popup-history-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'popup-history-btn';
    btn.innerHTML = 'üìä View History';
    btn.onclick = () => { map.closePopup(); openHistoryPanel(nodeId); };
    container.querySelector('.leaflet-popup-content').appendChild(btn);
});
</script>
</body>
</html>